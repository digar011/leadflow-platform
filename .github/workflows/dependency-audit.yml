name: Monthly Dependency Audit

on:
  schedule:
    # Runs at 09:00 UTC on the 1st of every month
    - cron: "0 9 1 * *"
  workflow_dispatch: # Allow manual trigger

permissions:
  contents: read
  issues: write

jobs:
  audit:
    name: Audit Dependencies
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Run npm audit
        id: audit
        run: |
          set +e
          AUDIT_OUTPUT=$(npm audit --json 2>&1)
          AUDIT_EXIT=$?
          set -e

          echo "$AUDIT_OUTPUT" > audit-report.json

          # Parse vulnerability counts
          CRITICAL=$(echo "$AUDIT_OUTPUT" | jq '.metadata.vulnerabilities.critical // 0')
          HIGH=$(echo "$AUDIT_OUTPUT" | jq '.metadata.vulnerabilities.high // 0')
          MODERATE=$(echo "$AUDIT_OUTPUT" | jq '.metadata.vulnerabilities.moderate // 0')
          LOW=$(echo "$AUDIT_OUTPUT" | jq '.metadata.vulnerabilities.low // 0')
          TOTAL=$(echo "$AUDIT_OUTPUT" | jq '.metadata.vulnerabilities.total // 0')

          echo "critical=$CRITICAL" >> "$GITHUB_OUTPUT"
          echo "high=$HIGH" >> "$GITHUB_OUTPUT"
          echo "moderate=$MODERATE" >> "$GITHUB_OUTPUT"
          echo "low=$LOW" >> "$GITHUB_OUTPUT"
          echo "total=$TOTAL" >> "$GITHUB_OUTPUT"
          echo "exit_code=$AUDIT_EXIT" >> "$GITHUB_OUTPUT"

      - name: Check for outdated packages
        id: outdated
        run: |
          set +e
          OUTDATED=$(npm outdated --json 2>&1)
          set -e
          echo "$OUTDATED" > outdated-report.json

          # Count outdated packages
          COUNT=$(echo "$OUTDATED" | jq 'length // 0')
          echo "count=$COUNT" >> "$GITHUB_OUTPUT"

      - name: Create GitHub Issue (if vulnerabilities found)
        if: steps.audit.outputs.total != '0'
        uses: actions/github-script@v7
        with:
          script: |
            const critical = ${{ steps.audit.outputs.critical }};
            const high = ${{ steps.audit.outputs.high }};
            const moderate = ${{ steps.audit.outputs.moderate }};
            const low = ${{ steps.audit.outputs.low }};
            const total = ${{ steps.audit.outputs.total }};
            const outdated = ${{ steps.outdated.outputs.count }};

            const severity = critical > 0 ? 'ðŸ”´ CRITICAL' : high > 0 ? 'ðŸŸ  HIGH' : 'ðŸŸ¡ MODERATE';
            const date = new Date().toISOString().split('T')[0];

            const body = `## Monthly Dependency Audit Report â€” ${date}

            ### Vulnerability Summary
            | Severity | Count |
            |----------|-------|
            | Critical | ${critical} |
            | High | ${high} |
            | Moderate | ${moderate} |
            | Low | ${low} |
            | **Total** | **${total}** |

            ### Outdated Packages
            ${outdated} packages have newer versions available.

            ### Action Required
            ${critical > 0 ? '- [ ] **Fix critical vulnerabilities within 24 hours**' : ''}
            ${high > 0 ? '- [ ] **Fix high vulnerabilities within 1 week**' : ''}
            ${moderate > 0 ? '- [ ] Review and address moderate vulnerabilities' : ''}
            - [ ] Run \`npm audit fix\` to auto-fix compatible updates
            - [ ] Run \`npm outdated\` to review available updates
            - [ ] Update TODO.md with findings

            ### How to Fix
            \`\`\`bash
            # Auto-fix compatible updates
            npm audit fix

            # Review what would change with breaking updates
            npm audit fix --dry-run --force

            # Check outdated packages
            npm outdated
            \`\`\`

            ---
            *Generated by the Monthly Dependency Audit workflow.*`;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `${severity} Dependency Audit â€” ${date} (${total} vulnerabilities)`,
              body: body,
              labels: ['dependencies', 'security']
            });

      - name: Upload audit report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: audit-reports
          path: |
            audit-report.json
            outdated-report.json
          retention-days: 90
